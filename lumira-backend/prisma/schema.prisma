// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Models
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  holdings      Holding[]
  transactions  Transaction[]
  settings      UserSettings?
  refreshTokens RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model UserSettings {
  id                String   @id @default(cuid())
  userId            String   @unique @map("user_id")
  theme             String   @default("system")
  defaultTimeRange  String   @default("1y") @map("default_time_range")
  refreshInterval   Int      @default(30) @map("refresh_interval")
  showEstimateWarning Boolean @default(true) @map("show_estimate_warning")
  hiddenFunds       String[] @default([]) @map("hidden_funds")
  groups            String[] @default([])
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// ============================================
// Fund Models
// ============================================

enum FundType {
  STOCK
  BOND
  MIX
  INDEX
  QDII
  FOF
  MONEY
}

enum RiskLevel {
  LOW
  LOW_MEDIUM
  MEDIUM
  MEDIUM_HIGH
  HIGH
}

model Fund {
  id            String    @id
  name          String
  type          FundType
  riskLevel     RiskLevel @map("risk_level")
  company       String
  managerId     String?   @map("manager_id")
  managerName   String?   @map("manager_name")
  nav           Decimal   @db.Decimal(10, 4)
  accumNav      Decimal   @map("accum_nav") @db.Decimal(10, 4)
  navDate       String    @map("nav_date")
  feeRateBuy    Decimal   @map("fee_rate_buy") @db.Decimal(5, 4)
  feeRateSell   Decimal   @map("fee_rate_sell") @db.Decimal(5, 4)
  feeRateMgmt   Decimal   @map("fee_rate_mgmt") @db.Decimal(5, 4)
  feeRateCustody Decimal? @map("fee_rate_custody") @db.Decimal(5, 4)
  scale         Decimal?  @db.Decimal(15, 2)
  establishDate String?   @map("establish_date")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  holdings      Holding[]
  navHistory    FundNavHistory[]

  @@index([type])
  @@index([riskLevel])
  @@map("funds")
}

model FundNavHistory {
  id        String   @id @default(cuid())
  fundId    String   @map("fund_id")
  date      String
  nav       Decimal  @db.Decimal(10, 4)
  accumNav  Decimal  @map("accum_nav") @db.Decimal(10, 4)
  change    Decimal? @db.Decimal(10, 4)
  changePercent Decimal? @map("change_percent") @db.Decimal(8, 4)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  fund      Fund     @relation(fields: [fundId], references: [id], onDelete: Cascade)

  @@unique([fundId, date])
  @@index([fundId])
  @@index([date])
  @@map("fund_nav_history")
}

// ============================================
// Holding Models
// ============================================

model Holding {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  fundId       String   @map("fund_id")
  fundName     String   @map("fund_name")
  fundType     FundType @map("fund_type")
  totalShares  Decimal  @map("total_shares") @db.Decimal(15, 4)
  avgCost      Decimal  @map("avg_cost") @db.Decimal(10, 4)
  totalCost    Decimal  @map("total_cost") @db.Decimal(15, 2)
  channel      String?
  group        String?
  tags         String[]
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  version      Int      @default(1)

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fund         Fund     @relation(fields: [fundId], references: [id])
  transactions Transaction[]

  @@index([userId])
  @@index([fundId])
  @@index([userId, fundId])
  @@map("holdings")
}

// ============================================
// Transaction Models
// ============================================

enum TransactionType {
  BUY
  SELL
  DIVIDEND
}

model Transaction {
  id        String          @id @default(cuid())
  userId    String          @map("user_id")
  holdingId String          @map("holding_id")
  fundId    String          @map("fund_id")
  fundName  String?         @map("fund_name")
  type      TransactionType
  date      String
  shares    Decimal         @db.Decimal(15, 4)
  price     Decimal         @db.Decimal(10, 4)
  amount    Decimal         @db.Decimal(15, 2)
  fee       Decimal         @db.Decimal(10, 2)
  notes     String?
  createdAt DateTime        @default(now()) @map("created_at")

  // Relations
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  holding   Holding         @relation(fields: [holdingId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([holdingId])
  @@index([fundId])
  @@index([date])
  @@map("transactions")
}
